name: CD - Staging Deployment (Develop)

on:
  push:
    branches: [ "develop" ] # Déclencheur : Push sur 'develop'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      REGISTRY: ${{ secrets.REGISTRY_URL }}
      NAMESPACE: shopyverse
      IMAGE_TAG: staging # Tag spécifique pour Staging

    steps:
      # 1. Checkout du code ET des Submodules
      - name: Checkout Code with Submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # 2. Authentification au Registre Docker
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_REGISTRY_USER }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

      # 3. Build & Push des 4 services (avec tag 'staging')
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Frontend
        uses: docker/build-push-action@v6
        with:
          context: services/frontend
          file: services/frontend/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/shopyverse-frontend:${{ env.IMAGE_TAG }}

      - name: Build & Push API Core
        uses: docker/build-push-action@v6
        with:
          context: services/api-core
          file: services/api-core/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/shopyverse-api-core:${{ env.IMAGE_TAG }}
          
      - name: Build & Push Reco Service
        uses: docker/build-push-action@v6
        with:
          context: services/reco-service
          file: services/reco-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/shopyverse-reco-service:${{ env.IMAGE_TAG }}

      - name: Build & Push Chatbot Service
        uses: docker/build-push-action@v6
        with:
          context: services/chatbot-service
          file: services/chatbot-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/shopyverse-chatbot-service:${{ env.IMAGE_TAG }}
      
      # --- DÉPLOIEMENT KUBERNETES VIA HELM ---
      
      # 4. Setup Kubeconfig (Staging) - Utilisation du Base64
      - name: Setup kubectl
        [cite_start]uses: azure/setup-kubectl@v4 [cite: 329]
      - name: Kubeconfig Setup (Staging) - DECODAGE BASE64
        run: |
          mkdir -p ~/.kube
          # Décodage du secret Base64 et écriture dans le fichier
          echo "${KUBECONFIG_B64}" | base64 -d > ~/.kube/config 
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG_STAGING_B64 }}

      # 5. Déploiement via Helm Upgrade
      - name: Render Helm values
        run: |
          cat > values.override.yaml <<EOF
          image:
            registry: ${REGISTRY}
            namespace: ${NAMESPACE}
            tags:
              apiCore: staging
              reco: staging
              chatbot: staging
              frontend: staging
          EOF
      - name: Helm upgrade to Staging
        run: |
          helm upgrade --install shopyverse ./helm \
            --namespace ${NAMESPACE} --create-namespace \
            [cite_start]-f ./helm/values.yaml -f values.override.yaml [cite: 351-353]
            
      # 6. Exécution des Smoke Tests
      - name: Run smoke tests
        [cite_start]run: ./scripts/smoke.sh [cite: 355-356]
