name: CD - Staging Deployment (Develop)

on:
  push:
    branches: [ "develop" ] # DÃ©clencheur : Push sur 'develop'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      REGISTRY: ${{ secrets.REGISTRY_URL }}
      NAMESPACE: shopyverse
      IMAGE_TAG: staging # Tag spÃ©cifique pour Staging

    steps:
      # 1. Checkout du code ET des Submodules
      - name: Checkout Code with Submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # 2. Authentification au Registre Docker (Pour le Push)
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_REGISTRY_USER }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

      # 3. Build & Push des 4 services (avec tag 'staging')
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push ðŸŒ Frontend
        uses: docker/build-push-action@v6
        with:
          context: services/frontend
          file: services/frontend/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/shopyverse-frontend:${{ env.IMAGE_TAG }}

      - name: Build & Push ðŸ–¥ï¸ API Core
        uses: docker/build-push-action@v6
        with:
          context: services/api-core
          file: services/api-core/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/shopyverse-api-core:${{ env.IMAGE_TAG }}
          
      - name: Build & Push ðŸ¤– Reco Service
        uses: docker/build-push-action@v6
        with:
          context: services/reco-service
          file: services/reco-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/shopyverse-reco-service:${{ env.IMAGE_TAG }}

      - name: Build & Push ðŸ’¬ Chatbot Service
        uses: docker/build-push-action@v6
        with:
          context: services/chatbot-service
          file: services/chatbot-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/shopyverse-chatbot-service:${{ env.IMAGE_TAG }}

      # --- DÃ‰PLOIEMENT KUBERNETES VIA HELM ---
      
      # 4. Setup Kubeconfig (Staging)
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
      - name: Kubeconfig Setup (Staging)
        run: |
          mkdir -p ~/.kube
          echo "${KUBECONFIG_FILE}" > ~/.kube/config 
        env:
          KUBECONFIG_FILE: ${{ secrets.KUBECONFIG_STAGING }}

      # 5. DÃ©ploiement via Helm Upgrade
      - name: Render Helm values
        run: |
          cat > values.override.yaml <<EOF
          image:
            registry: ${REGISTRY}
            namespace: ${NAMESPACE}
            tags:
              apiCore: staging
              reco: staging
              chatbot: staging
              frontend: staging
          EOF
      - name: Helm upgrade to Staging
        run: |
          helm upgrade --install shopyverse ./helm \
            --namespace ${NAMESPACE} --create-namespace \
            -f ./helm/values.yaml -f values.override.yaml
            
      # 6. ExÃ©cution des Smoke Tests
      - name: Run smoke tests
        run: ./scripts/smoke.sh
